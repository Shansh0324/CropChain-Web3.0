<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="google-site-verification" content="Zpk75pai0n043qoYJTK1cpq6zJuKxmftDDkXGzBhk7M" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Croponchain - Blockchain Crop Traceability</title>
    <link rel="icon" href="data:,"> <!-- Prevent favicon 404 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #514caf;
        }

        .logo i {
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: #514caf;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .hero {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #514caf 0%, #6c5ce7 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #514caf 0%, #6c5ce7 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(81, 76, 175, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(81, 76, 175, 0.4);
        }
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #514caf;
            box-shadow: 0 0 0 3px rgba(81, 76, 175, 0.1);
        }

        .form-input:read-only {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .form-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: #514caf;
            box-shadow: 0 0 0 3px rgba(81, 76, 175, 0.1);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-connected {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .status-disconnected {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-connected .status-dot {
            background: #28a745;
        }

        .status-disconnected .status-dot {
            background: #dc3545;
        }

        .wallet-info {
            background: rgba(81, 76, 175, 0.1);
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .batch-display {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #514caf;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: center;
        }

        .batch-number {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: #514caf;
            margin-bottom: 0.5rem;
        }

        .qr-section {
            text-align: center;
            margin: 2rem 0;
        }

        .qr-display {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .qr-display.show {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        .output {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #514caf;
        }

        .error {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            border-left-color: #dc3545;
        }

        .success {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            border-left-color: #28a745;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #514caf;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .marketplace-section {
            grid-column: 1 / -1;
            margin-top: 2rem;
        }

        .marketplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .marketplace-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #f0f0f0;
        }

        .marketplace-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .price-tag {
            background: linear-gradient(135deg, #514caf 0%, #6c5ce7 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            display: inline-block;
            margin: 0.5rem 0;
        }

        .farmer-info {
            color: #666;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }

        .batch-info {
            background: rgba(81, 76, 175, 0.1);
            padding: 0.5rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            margin: 0.5rem 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .nav-links {
                display: none;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .container {
                padding: 0 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #514caf 0%, #6c5ce7 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            margin: 0 auto 1rem;
        }
        .qr-code-section {
            background-color: #f8f9fa;
            border: 2px solid #514caf;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .qr-code-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-seedling"></i>
                <span>Croponchain</span>
            </div>
            <ul class="nav-links">
                <li><a href="#home">Home</a></li>
                <li><a href="#marketplace">Marketplace</a></li>
                <li><a href="#verify">Verify</a></li>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="container">
        <div class="hero">
            <h1>🌾 Croponchain</h1>
            <p>Blockchain-based crop traceability and marketplace system for transparent agricultural supply chains</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Wallet Connection Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="card-title">Connect Wallet</div>
                </div>
                <button id="connectBtn" class="btn btn-primary">
                    <i class="fas fa-plug"></i>
                    Connect MetaMask
                </button>
                <div id="walletStatus" class="status-indicator status-disconnected">
                    <span class="status-dot"></span>
                    Not Connected
                </div>
                <div id="walletInfo" class="wallet-info" style="display: none;"></div>
        <div id="connectionStatus" class="output"></div>
            </div>

            <!-- Crop Registration Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="card-title">Register Your Crop</div>
                </div>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            <strong>Step 1:</strong> Select your crop from the dropdown below. The Crop ID will be automatically assigned.
        </p>
                <div class="form-group">
                    <label class="form-label">Crop ID</label>
                    <input type="text" id="cropId" class="form-input" placeholder="Crop ID (auto-selected)" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Crop Name</label>
                    <select id="cropName" class="form-select">
            <option value="">Select Crop Name</option>
        </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Farmer / Producer</label>
                    <input type="text" id="cropManufacturer" class="form-input" placeholder="Enter your name or farm name">
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity (kg/units)</label>
                    <input type="number" id="cropQuantity" class="form-input" placeholder="Enter quantity" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Price per unit (₹)</label>
                    <input type="number" id="cropPrice" class="form-input" placeholder="Enter price per unit" step="0.01" min="0">
                </div>
                
                <h3 style="color: #514caf; margin-top: 20px; margin-bottom: 10px;">Location Details (for Batch Number Generation)</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            <strong>How it works:</strong> Fill in your location details below, then click "Generate Batch Number". 
            The system will create a unique batch number using your state code, district, post office number, 
            current date, and your wallet address. Example: <code>OD-14-102-190925-A3F9</code>
        </p>
                <div class="form-group">
                    <label class="form-label">State</label>
                    <select id="stateSelect" class="form-select">
            <option value="">Select State</option>
            <option value="Andhra Pradesh">Andhra Pradesh</option>
            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
            <option value="Assam">Assam</option>
            <option value="Bihar">Bihar</option>
            <option value="Chhattisgarh">Chhattisgarh</option>
            <option value="Goa">Goa</option>
            <option value="Gujarat">Gujarat</option>
            <option value="Haryana">Haryana</option>
            <option value="Himachal Pradesh">Himachal Pradesh</option>
            <option value="Jharkhand">Jharkhand</option>
            <option value="Karnataka">Karnataka</option>
            <option value="Kerala">Kerala</option>
            <option value="Madhya Pradesh">Madhya Pradesh</option>
            <option value="Maharashtra">Maharashtra</option>
            <option value="Manipur">Manipur</option>
            <option value="Meghalaya">Meghalaya</option>
            <option value="Mizoram">Mizoram</option>
            <option value="Nagaland">Nagaland</option>
            <option value="Odisha">Odisha</option>
            <option value="Punjab">Punjab</option>
            <option value="Rajasthan">Rajasthan</option>
            <option value="Sikkim">Sikkim</option>
            <option value="Tamil Nadu">Tamil Nadu</option>
            <option value="Telangana">Telangana</option>
            <option value="Tripura">Tripura</option>
            <option value="Uttar Pradesh">Uttar Pradesh</option>
            <option value="Uttarakhand">Uttarakhand</option>
            <option value="West Bengal">West Bengal</option>
        </select>
                </div>
                <div class="form-group">
                    <label class="form-label">District Code</label>
                    <input type="number" id="districtCode" class="form-input" placeholder="District Code (e.g., 14)">
                </div>
                <div class="form-group">
                    <label class="form-label">Post Office Number</label>
                    <input type="number" id="postOfficeNumber" class="form-input" placeholder="Post Office Number (e.g., 102)">
                </div>
                
                <div class="btn-group">
                    <button id="generateBatchBtn" class="btn btn-secondary">
                        <i class="fas fa-barcode"></i>
                        Generate Batch Number
                    </button>
                </div>
        <div id="generatedBatch" class="batch-display" style="display: none;"></div>
        
                <div class="form-group">
                    <label class="form-label">Batch Number <span style="color: #666; font-size: 12px;">(Auto-Generated)</span></label>
                    <input type="text" id="cropBatchNumber" class="form-input" placeholder="Batch Number (auto-generated)" readonly>
                    <div style="background: rgba(33, 150, 243, 0.1); padding: 0.5rem; border-radius: 8px; border-left: 4px solid #2196f3; margin-top: 0.5rem; font-size: 12px;">
                        <strong>💡 Automatic Generation:</strong> A unique batch number will be automatically generated when you register the crop. Each registration gets a completely unique identifier.
                    </div>
                </div>
        
                <h3 style="color: #514caf; margin-top: 20px; margin-bottom: 10px;">QR Code Generation</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            <strong>Generate QR Code:</strong> After registering your crop, generate a QR code that consumers can scan to view all crop details and verify authenticity on the blockchain.
        </p>
                <div class="btn-group">
                    <button id="generateQRBtn" class="btn btn-success" style="display: none;">
                        <i class="fas fa-qrcode"></i>
                        Generate QR Code
                    </button>
                    <button id="testQRBtn" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-test-tube"></i>
                        Test QR Library
                    </button>
                </div>
                <div id="qrCodeDisplay" class="qr-display" style="display: none;">
            <h4>Your Crop QR Code</h4>
            <p style="color: #666; margin-bottom: 20px;">Consumers can scan this QR code to verify your crop details and authenticity on the blockchain.</p>
            <div class="qr-code-container">
                <div id="qrCodeContainer"></div>
            </div>
                    <div class="btn-group">
                        <button id="downloadQRBtn" class="btn btn-primary">
                            <i class="fas fa-download"></i>
                            Download QR Code
                        </button>
                    </div>
        </div>
        
                <div class="btn-group">
                    <button id="registerCropBtn" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i>
                        Register Crop
                    </button>
                </div>
            </div>

            <!-- Marketplace Card -->
            <div class="card marketplace-section">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="card-title">Crop Marketplace</div>
                </div>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            <strong>Browse all farmers selling the same crop:</strong> Select a crop to see all farmers who have registered it, along with their prices and details.
        </p>
                <div class="form-group">
                    <label class="form-label">Select Crop to Browse</label>
                    <select id="marketplaceCropSelect" class="form-select">
            <option value="">Select Crop to Browse Marketplace</option>
        </select>
                </div>
                <div class="btn-group">
                    <button id="browseMarketplaceBtn" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        Browse Marketplace
                    </button>
                </div>
            </div>

            <!-- Individual Crop Details Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="card-title">Get Individual Crop Details</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Batch Number</label>
                    <input type="text" id="cropIdForDetails" class="form-input" placeholder="Enter Batch Number (e.g., OD-14-102-190925-A3F9)">
                </div>
                <div class="btn-group">
                    <button id="getCropDetailsBtn" class="btn btn-secondary">
                        <i class="fas fa-search"></i>
                        Get Individual Details
                    </button>
                </div>
            </div>

            <!-- Transfer Ownership Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="card-title">Transfer Ownership</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Batch Number</label>
                    <input type="text" id="transferId" class="form-input" placeholder="Enter Batch Number">
                </div>
                <div class="form-group">
                    <label class="form-label">New Owner Address</label>
                    <input type="text" id="newOwner" class="form-input" placeholder="New Owner Address (0x...)">
                </div>
                <div class="form-group">
                    <label class="form-label">New Owner Name</label>
                    <input type="text" id="newOwnerName" class="form-input" placeholder="Enter new owner's name or farm name">
                    <small style="color: #666; font-size: 0.9rem; margin-top: 0.5rem; display: block;">
                        This will update the producer/manufacturer name for the crop
                    </small>
                </div>
                <div class="btn-group">
                    <button id="transferOwnershipBtn" class="btn btn-secondary">
                        <i class="fas fa-exchange-alt"></i>
                        Transfer Ownership
                    </button>
                </div>
            </div>

            <!-- Update Manufacturer Name Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="card-title">Update Manufacturer Name</div>
                </div>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    <strong>For current owners:</strong> Update your name or farm name without transferring ownership.
                </p>
                <div class="form-group">
                    <label class="form-label">Batch Number</label>
                    <input type="text" id="updateNameCropId" class="form-input" placeholder="Enter Batch Number">
                </div>
                <div class="form-group">
                    <label class="form-label">New Manufacturer Name</label>
                    <input type="text" id="newManufacturerName" class="form-input" placeholder="Enter your new name or farm name">
                </div>
                <div class="btn-group">
                    <button id="updateManufacturerBtn" class="btn btn-secondary">
                        <i class="fas fa-edit"></i>
                        Update Name
                    </button>
                </div>
            </div>
        </div>

        <div id="output" class="output"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
    <!-- QR Code library - multiple CDN options -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" onerror="loadFallbackQR()"></script>
    <script>
        function loadFallbackQR() {
            console.log("Loading fallback QR library...");
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js';
            script.onerror = function() {
                console.error("All QR libraries failed to load");
            };
            document.head.appendChild(script);
        }
    </script>
    <script>
        const contractAddress = "0xDb1dEd4afBf9162a53B0B8A4989554943FB755b4"; 
        const contractABI = [
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "string",
        "name": "batchNumber",
        "type": "string"
      },
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "cropTypeId",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "name",
        "type": "string"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "manufacturer",
        "type": "string"
      },
      {
        "indexed": false,
        "internalType": "address",
        "name": "owner",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "quantity",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "price",
        "type": "uint256"
      }
    ],
    "name": "CropRegistered",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "string",
        "name": "batchNumber",
        "type": "string"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "previousOwner",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "newOwner",
        "type": "address"
      }
    ],
    "name": "OwnershipTransferred",
    "type": "event"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "allBatchNumbers",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_batchNumber",
        "type": "string"
      }
    ],
    "name": "batchExists",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "cropTypeToBatches",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      }
    ],
    "name": "crops",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "cropTypeId",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "manufacturer",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "batchNumber",
        "type": "string"
      },
      {
        "internalType": "address",
        "name": "owner",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "registrationTime",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "quantity",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "price",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getAllBatchNumbers",
    "outputs": [
      {
        "internalType": "string[]",
        "name": "",
        "type": "string[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_cropTypeId",
        "type": "uint256"
      }
    ],
    "name": "getBatchesByCropType",
    "outputs": [
      {
        "internalType": "string[]",
        "name": "",
        "type": "string[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_batchNumber",
        "type": "string"
      }
    ],
    "name": "getCropByBatch",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "cropTypeId",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "manufacturer",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "batchNumber",
        "type": "string"
      },
      {
        "internalType": "address",
        "name": "owner",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "registrationTime",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "quantity",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "price",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_cropTypeId",
        "type": "uint256"
      }
    ],
    "name": "getCropCountByType",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getTotalRegistrations",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_cropTypeId",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_manufacturer",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_batchNumber",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "_quantity",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "_price",
        "type": "uint256"
      }
    ],
    "name": "registerCrop",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "totalRegistrations",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_batchNumber",
        "type": "string"
      },
      {
        "internalType": "address",
        "name": "_newOwner",
        "type": "address"
      }
    ],
    "name": "transferOwnership",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_batchNumber",
        "type": "string"
      },
      {
        "internalType": "address",
        "name": "_newOwner",
        "type": "address"
      },
      {
        "internalType": "string",
        "name": "_newManufacturer",
        "type": "string"
      }
    ],
    "name": "transferOwnershipWithName",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_batchNumber",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_newManufacturer",
        "type": "string"
      }
    ],
    "name": "updateManufacturer",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_batchNumber",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "_newPrice",
        "type": "uint256"
      }
    ],
    "name": "updatePrice",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  }
];

        let web3;
        let contract;
        let userAccount;

        // State code mapping for batch number generation
        const stateCodes = {
            "Andhra Pradesh": "AP",
            "Arunachal Pradesh": "AR",
            "Assam": "AS",
            "Bihar": "BR",
            "Chhattisgarh": "CG",
            "Goa": "GA",
            "Gujarat": "GJ",
            "Haryana": "HR",
            "Himachal Pradesh": "HP",
            "Jharkhand": "JH",
            "Karnataka": "KA",
            "Kerala": "KL",
            "Madhya Pradesh": "MP",
            "Maharashtra": "MH",
            "Manipur": "MN",
            "Meghalaya": "ML",
            "Mizoram": "MZ",
            "Nagaland": "NL",
            "Odisha": "OD",
            "Punjab": "PB",
            "Rajasthan": "RJ",
            "Sikkim": "SK",
            "Tamil Nadu": "TN",
            "Telangana": "TG",
            "Tripura": "TR",
            "Uttar Pradesh": "UP",
            "Uttarakhand": "UK",
            "West Bengal": "WB"
        };

        // Standardized crop database with unique IDs
        const cropDatabase = [
            // Cereals (C001-C020)
            { id: "C001", name: "Rice", category: "Cereal" },
            { id: "C002", name: "Wheat", category: "Cereal" },
            { id: "C003", name: "Maize", category: "Cereal" },
            { id: "C004", name: "Barley", category: "Cereal" },
            { id: "C005", name: "Pearl Millet (Bajra)", category: "Cereal" },
            { id: "C006", name: "Finger Millet (Ragi)", category: "Cereal" },
            { id: "C007", name: "Sorghum (Jowar)", category: "Cereal" },
            { id: "C008", name: "Foxtail Millet", category: "Cereal" },
            { id: "C009", name: "Little Millet", category: "Cereal" },
            { id: "C010", name: "Kodo Millet", category: "Cereal" },
            { id: "C011", name: "Proso Millet", category: "Cereal" },
            { id: "C012", name: "Barnyard Millet", category: "Cereal" },
            { id: "C013", name: "Oats", category: "Cereal" },
            { id: "C014", name: "Quinoa", category: "Cereal" },
            { id: "C015", name: "Buckwheat", category: "Cereal" },

            // Pulses (C016-C035)
            { id: "C016", name: "Chickpea (Chana)", category: "Pulse" },
            { id: "C017", name: "Pigeon Pea (Arhar/Tur)", category: "Pulse" },
            { id: "C018", name: "Black Gram (Urad)", category: "Pulse" },
            { id: "C019", name: "Green Gram (Moong)", category: "Pulse" },
            { id: "C020", name: "Lentil (Masoor)", category: "Pulse" },
            { id: "C021", name: "Red Kidney Bean (Rajma)", category: "Pulse" },
            { id: "C022", name: "Black Eyed Pea (Lobia)", category: "Pulse" },
            { id: "C023", name: "Horse Gram", category: "Pulse" },
            { id: "C024", name: "Moth Bean", category: "Pulse" },
            { id: "C025", name: "Cowpea", category: "Pulse" },
            { id: "C026", name: "Field Pea", category: "Pulse" },
            { id: "C027", name: "Broad Bean", category: "Pulse" },
            { id: "C028", name: "Lima Bean", category: "Pulse" },
            { id: "C029", name: "Adzuki Bean", category: "Pulse" },
            { id: "C030", name: "Mung Bean", category: "Pulse" },

            // Oilseeds (C031-C050)
            { id: "C031", name: "Groundnut (Peanut)", category: "Oilseed" },
            { id: "C032", name: "Mustard", category: "Oilseed" },
            { id: "C033", name: "Sesame (Til)", category: "Oilseed" },
            { id: "C034", name: "Sunflower", category: "Oilseed" },
            { id: "C035", name: "Soybean", category: "Oilseed" },
            { id: "C036", name: "Safflower", category: "Oilseed" },
            { id: "C037", name: "Niger", category: "Oilseed" },
            { id: "C038", name: "Castor", category: "Oilseed" },
            { id: "C039", name: "Linseed", category: "Oilseed" },
            { id: "C040", name: "Rapeseed", category: "Oilseed" },
            { id: "C041", name: "Cottonseed", category: "Oilseed" },
            { id: "C042", name: "Coconut", category: "Oilseed" },
            { id: "C043", name: "Palm Oil", category: "Oilseed" },
            { id: "C044", name: "Olive", category: "Oilseed" },
            { id: "C045", name: "Jatropha", category: "Oilseed" },

            // Commercial Crops (C046-C065)
            { id: "C046", name: "Sugarcane", category: "Commercial" },
            { id: "C047", name: "Cotton", category: "Commercial" },
            { id: "C048", name: "Jute", category: "Commercial" },
            { id: "C049", name: "Tobacco", category: "Commercial" },
            { id: "C050", name: "Tea", category: "Commercial" },
            { id: "C051", name: "Coffee", category: "Commercial" },
            { id: "C052", name: "Rubber", category: "Commercial" },
            { id: "C053", name: "Spices (Mixed)", category: "Commercial" },
            { id: "C054", name: "Turmeric", category: "Commercial" },
            { id: "C055", name: "Ginger", category: "Commercial" },
            { id: "C056", name: "Black Pepper", category: "Commercial" },
            { id: "C057", name: "Cardamom", category: "Commercial" },
            { id: "C058", name: "Cinnamon", category: "Commercial" },
            { id: "C059", name: "Cloves", category: "Commercial" },
            { id: "C060", name: "Nutmeg", category: "Commercial" },

            // Fruits (C061-C085)
            { id: "C061", name: "Mango", category: "Fruit" },
            { id: "C062", name: "Banana", category: "Fruit" },
            { id: "C063", name: "Apple", category: "Fruit" },
            { id: "C064", name: "Orange", category: "Fruit" },
            { id: "C065", name: "Grape", category: "Fruit" },
            { id: "C066", name: "Pomegranate", category: "Fruit" },
            { id: "C067", name: "Guava", category: "Fruit" },
            { id: "C068", name: "Papaya", category: "Fruit" },
            { id: "C069", name: "Coconut", category: "Fruit" },
            { id: "C070", name: "Lemon", category: "Fruit" },
            { id: "C071", name: "Lime", category: "Fruit" },
            { id: "C072", name: "Sweet Lime", category: "Fruit" },
            { id: "C073", name: "Custard Apple", category: "Fruit" },
            { id: "C074", name: "Jackfruit", category: "Fruit" },
            { id: "C075", name: "Jamun", category: "Fruit" },
            { id: "C076", name: "Ber", category: "Fruit" },
            { id: "C077", name: "Amla", category: "Fruit" },
            { id: "C078", name: "Fig", category: "Fruit" },
            { id: "C079", name: "Date Palm", category: "Fruit" },
            { id: "C080", name: "Kiwi", category: "Fruit" },

            // Vegetables (C081-C110)
            { id: "C081", name: "Potato", category: "Vegetable" },
            { id: "C082", name: "Onion", category: "Vegetable" },
            { id: "C083", name: "Tomato", category: "Vegetable" },
            { id: "C084", name: "Brinjal (Eggplant)", category: "Vegetable" },
            { id: "C085", name: "Okra (Lady's Finger)", category: "Vegetable" },
            { id: "C086", name: "Cauliflower", category: "Vegetable" },
            { id: "C087", name: "Cabbage", category: "Vegetable" },
            { id: "C088", name: "Carrot", category: "Vegetable" },
            { id: "C089", name: "Radish", category: "Vegetable" },
            { id: "C090", name: "Beetroot", category: "Vegetable" },
            { id: "C091", name: "Spinach", category: "Vegetable" },
            { id: "C092", name: "Fenugreek (Methi)", category: "Vegetable" },
            { id: "C093", name: "Coriander", category: "Vegetable" },
            { id: "C094", name: "Mint", category: "Vegetable" },
            { id: "C095", name: "Cucumber", category: "Vegetable" },
            { id: "C096", name: "Bottle Gourd", category: "Vegetable" },
            { id: "C097", name: "Ridge Gourd", category: "Vegetable" },
            { id: "C098", name: "Bitter Gourd", category: "Vegetable" },
            { id: "C099", name: "Snake Gourd", category: "Vegetable" },
            { id: "C100", name: "Ash Gourd", category: "Vegetable" },
            { id: "C101", name: "Pumpkin", category: "Vegetable" },
            { id: "C102", name: "Green Peas", category: "Vegetable" },
            { id: "C103", name: "French Beans", category: "Vegetable" },
            { id: "C104", name: "Cluster Beans", category: "Vegetable" },
            { id: "C105", name: "Drumstick", category: "Vegetable" },
            { id: "C106", name: "Sweet Potato", category: "Vegetable" },
            { id: "C107", name: "Tapioca", category: "Vegetable" },
            { id: "C108", name: "Yam", category: "Vegetable" },
            { id: "C109", name: "Colocasia", category: "Vegetable" },
            { id: "C110", name: "Elephant Foot Yam", category: "Vegetable" }
        ];

        // Function to populate crop dropdown
        function populateCropDropdown() {
            const cropSelect = document.getElementById("cropName");
            const marketplaceSelect = document.getElementById("marketplaceCropSelect");
            
            // Group crops by category
            const categories = {};
            cropDatabase.forEach(crop => {
                if (!categories[crop.category]) {
                    categories[crop.category] = [];
                }
                categories[crop.category].push(crop);
            });

            // Add options grouped by category to both dropdowns
            [cropSelect, marketplaceSelect].forEach(select => {
                Object.keys(categories).forEach(category => {
                    const optgroup = document.createElement("optgroup");
                    optgroup.label = category;
                    
                    categories[category].forEach(crop => {
                        const option = document.createElement("option");
                        option.value = crop.name;
                        option.textContent = `${crop.name} (${crop.id})`;
                        option.dataset.cropId = crop.id;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                });
            });
        }

        // Function to handle crop selection and auto-populate crop ID
        function handleCropSelection() {
            const cropSelect = document.getElementById("cropName");
            const cropIdInput = document.getElementById("cropId");
            
            if (cropSelect.value) {
                const selectedOption = cropSelect.options[cropSelect.selectedIndex];
                const cropId = selectedOption.dataset.cropId;
                cropIdInput.value = cropId;
                
                // Check if this crop is already registered
                checkCropAvailability(cropId);
            } else {
                cropIdInput.value = "";
            }
        }

        // Function to check crop type availability (new contract allows multiple registrations)
        async function checkCropAvailability(cropId) {
            if (!isContractReady()) {
                return;
            }
            
            try {
                const numericId = parseInt(cropId.replace('C', ''));
                const cropCount = await contract.methods.getCropCountByType(numericId).call();
                
                const cropSelect = document.getElementById("cropName");
                const selectedOption = cropSelect.options[cropSelect.selectedIndex];
                
                if (parseInt(cropCount) > 0) {
                    // Crop type has been registered before
                    selectedOption.style.backgroundColor = "#e8f5e8";
                    selectedOption.style.color = "#2e7d32";
                    selectedOption.title = `${cropCount} batch(es) already registered for this crop type`;
                    
                    // Show info message
                    const warningDiv = document.getElementById("cropWarning") || createCropWarning();
                    warningDiv.innerHTML = `
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 0.5rem; border-radius: 8px; border-left: 4px solid #4caf50; margin-top: 0.5rem;">
                            <strong>✅ Good News:</strong> ${cropId} (${selectedOption.textContent}) can be registered multiple times!
                            <br><strong>📊 Current batches:</strong> ${cropCount} batch(es) already registered
                            <br><strong>💡 Tip:</strong> Each registration needs a unique batch number.
                        </div>
                    `;
                    warningDiv.style.display = "block";
                } else {
                    // Crop type has never been registered
                    selectedOption.style.backgroundColor = "#e3f2fd";
                    selectedOption.style.color = "#1976d2";
                    selectedOption.title = "New crop type - first registration";
                    
                    // Show info message
                    const warningDiv = document.getElementById("cropWarning") || createCropWarning();
                    warningDiv.innerHTML = `
                        <div style="background: rgba(33, 150, 243, 0.1); padding: 0.5rem; border-radius: 8px; border-left: 4px solid #2196f3; margin-top: 0.5rem;">
                            <strong>🆕 New Crop Type:</strong> ${cropId} (${selectedOption.textContent}) has never been registered before!
                            <br><strong>💡 Tip:</strong> You can register this crop type multiple times with different batch numbers.
                        </div>
                    `;
                    warningDiv.style.display = "block";
                }
            } catch (error) {
                // Error checking, assume available
                console.log("Error checking crop availability:", error);
                const cropSelect = document.getElementById("cropName");
                const selectedOption = cropSelect.options[cropSelect.selectedIndex];
                selectedOption.style.backgroundColor = "";
                selectedOption.style.color = "";
                selectedOption.title = "Available for registration";
            }
        }

        // Function to create crop warning element
        function createCropWarning() {
            const warningDiv = document.createElement("div");
            warningDiv.id = "cropWarning";
            warningDiv.style.display = "none";
            
            const cropSelect = document.getElementById("cropName");
            cropSelect.parentNode.insertBefore(warningDiv, cropSelect.nextSibling);
            
            return warningDiv;
        }

        // Function to generate farmer ID (first 2 initials + last 6 wallet digits)
        function generateFarmerId(farmerName, walletAddress) {
            if (!farmerName || !walletAddress) return null;
            
            // Get first 2 initials from farmer name
            const nameParts = farmerName.trim().split(' ');
            let initials = '';
            
            if (nameParts.length >= 2) {
                initials = nameParts[0].charAt(0).toUpperCase() + nameParts[1].charAt(0).toUpperCase();
            } else if (nameParts.length === 1) {
                initials = nameParts[0].substring(0, 2).toUpperCase();
            }
            
            // Get last 6 characters of wallet address
            const walletSuffix = walletAddress.slice(-6).toLowerCase();
            
            return `${initials}-${walletSuffix}`;
        }

        // Function to show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Function to update wallet status
        function updateWalletStatus(connected, account = null) {
            const statusElement = document.getElementById('walletStatus');
            const walletInfoElement = document.getElementById('walletInfo');
            
            if (connected && account) {
                statusElement.className = 'status-indicator status-connected';
                statusElement.innerHTML = '<span class="status-dot"></span>Connected';
                walletInfoElement.textContent = `Account: ${account}`;
                walletInfoElement.style.display = 'block';
            } else {
                statusElement.className = 'status-indicator status-disconnected';
                statusElement.innerHTML = '<span class="status-dot"></span>Not Connected';
                walletInfoElement.style.display = 'none';
            }
        }

        // Helper function to check if contract is ready
        function isContractReady() {
            return contract && contract.methods && web3 && userAccount;
        }

        // Helper function to get contract status
        function getContractStatus() {
            if (!web3) return "Web3 not initialized";
            if (!contract) return "Contract not initialized";
            if (!contract.methods) return "Contract methods not available";
            if (!userAccount) return "Wallet not connected";
            return "Ready";
        }

        async function initWeb3() {
            try {
                if (typeof window.ethereum !== "undefined") {
                    web3 = new Web3(window.ethereum);
                    
                    // Validate contract ABI and address
                    if (!contractABI || !contractAddress) {
                        throw new Error("Contract ABI or address not found");
                    }
                    
                    contract = new web3.eth.Contract(contractABI, contractAddress);
                    
                    // Test contract connection
                    try {
                        const totalRegistrations = await contract.methods.getTotalRegistrations().call();
                        console.log("Contract connection verified, total registrations:", totalRegistrations);
                    } catch (contractError) {
                        console.warn("Contract connection test failed:", contractError);
                        console.warn("This might be due to network issues or contract not being fully deployed");
                        // Continue anyway, as the contract might still work for other methods
                    }
                    
                    try {
                        await window.ethereum.request({ method: "eth_requestAccounts" });
                        userAccount = (await web3.eth.getAccounts())[0];
                        
                        if (userAccount) {
                            updateWalletStatus(true, userAccount);
                            document.getElementById("connectionStatus").innerText = "MetaMask Connected: " + userAccount;
                            document.getElementById("connectionStatus").classList.add("success");
                            showNotification("Wallet connected successfully!", "success");
                        } else {
                            throw new Error("No accounts found");
                        }
                    } catch (error) {
                        updateWalletStatus(false);
                        document.getElementById("connectionStatus").innerText = "MetaMask connection failed: " + error.message;
                        document.getElementById("connectionStatus").classList.add("error");
                        showNotification("Failed to connect wallet: " + error.message, "error");
                    }
                } else {
                    updateWalletStatus(false);
                    document.getElementById("connectionStatus").innerText = "Please install MetaMask.";
                    document.getElementById("connectionStatus").classList.add("error");
                    showNotification("Please install MetaMask to continue", "error");
                }
            } catch (error) {
                console.error("Error initializing Web3:", error);
                updateWalletStatus(false);
                document.getElementById("connectionStatus").innerText = "Web3 initialization failed: " + error.message;
                document.getElementById("connectionStatus").classList.add("error");
                showNotification("Web3 initialization failed", "error");
            }
        }

        function generateBatchNumber() {
            // Check if MetaMask is connected
            if (!userAccount) {
                document.getElementById("generatedBatch").innerText = "Please connect MetaMask first!";
                document.getElementById("generatedBatch").classList.add("error");
                document.getElementById("generatedBatch").style.display = "block";
                return;
            }

            // Get form values
            const state = document.getElementById("stateSelect").value;
            const districtCode = document.getElementById("districtCode").value;
            const postOfficeNumber = document.getElementById("postOfficeNumber").value;

            // Validate inputs
            if (!state || !districtCode || !postOfficeNumber) {
                document.getElementById("generatedBatch").innerText = "Please fill in all location details!";
                document.getElementById("generatedBatch").classList.add("error");
                document.getElementById("generatedBatch").style.display = "block";
                return;
            }

            try {
                // Generate unique batch number
                const batchNumber = generateUniqueBatchNumber();

                // Display generated batch number
                document.getElementById("generatedBatch").innerHTML = `
                    <strong>Generated Batch Number:</strong><br>
                    <span style="font-family: monospace; font-size: 18px; color: #514caf;">${batchNumber}</span>
                `;
                document.getElementById("generatedBatch").classList.remove("error");
                document.getElementById("generatedBatch").classList.add("success");
                document.getElementById("generatedBatch").style.display = "block";

                // Auto-fill the batch number field
                document.getElementById("cropBatchNumber").value = batchNumber;

            } catch (error) {
                document.getElementById("generatedBatch").innerText = "Error generating batch number: " + error.message;
                document.getElementById("generatedBatch").classList.add("error");
                document.getElementById("generatedBatch").style.display = "block";
            }
        }

        // Function to generate a completely unique batch number with timestamp and random elements
        function generateUniqueBatchNumber() {
            // Get form values
            const state = document.getElementById("stateSelect").value;
            const districtCode = document.getElementById("districtCode").value;
            const postOfficeNumber = document.getElementById("postOfficeNumber").value;

            // Use default values if location fields are not filled
            let stateCode, finalDistrictCode, finalPostOfficeNumber;
            
            if (state && districtCode && postOfficeNumber) {
                // Get state code (first two characters)
                stateCode = stateCodes[state];
                if (!stateCode) {
                    throw new Error("Invalid state selected");
                }
                finalDistrictCode = districtCode;
                finalPostOfficeNumber = postOfficeNumber;
            } else {
                // Use default values for automatic generation
                stateCode = "XX";
                finalDistrictCode = "00";
                finalPostOfficeNumber = "000";
            }

            // Get current date and time for maximum uniqueness
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = String(now.getFullYear()).slice(-2);
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const milliseconds = String(now.getMilliseconds()).padStart(3, '0');
            
            // Create timestamp string: DDMMYYHHMMSSMMM
            const timestamp = day + month + year + hours + minutes + seconds + milliseconds;

            // Get last 4 characters of wallet address for user identification
            const walletSuffix = userAccount ? userAccount.slice(-4).toUpperCase() : "XXXX";

            // Generate random 4-character code for extra uniqueness
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let randomCode = '';
            for (let i = 0; i < 4; i++) {
                randomCode += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            // Construct unique batch number: [StateCode]-[DistrictCode]-[PostOfficeNumber]-[Timestamp]-[WalletSuffix]-[Random]
            const batchNumber = `${stateCode}-${finalDistrictCode}-${finalPostOfficeNumber}-${timestamp}-${walletSuffix}-${randomCode}`;

            return batchNumber;
        }

        // Function to automatically generate batch number when location fields are filled
        function autoGenerateBatchNumber() {
            const state = document.getElementById("stateSelect").value;
            const districtCode = document.getElementById("districtCode").value;
            const postOfficeNumber = document.getElementById("postOfficeNumber").value;
            
            // Only auto-generate if all location fields are filled and user is connected
            if (state && districtCode && postOfficeNumber && userAccount) {
                generateBatchNumber();
            }
        }

        async function registerCrop() {
            const cropId = document.getElementById("cropId").value;
            const cropName = document.getElementById("cropName").value;
            const cropManufacturer = document.getElementById("cropManufacturer").value;
            const cropQuantity = document.getElementById("cropQuantity").value;
            let cropBatchNumber = document.getElementById("cropBatchNumber").value;
            const cropPrice = document.getElementById("cropPrice").value;

            // Validation
            if (!cropId || !cropName || !cropManufacturer || !cropQuantity || !cropPrice) {
                document.getElementById("output").innerText = "Please fill in all required fields including quantity and price!";
                document.getElementById("output").classList.add("error");
                return;
            }

            // Auto-generate batch number if not provided
            if (!cropBatchNumber || cropBatchNumber.trim() === "") {
                console.log("No batch number provided, auto-generating...");
                try {
                    cropBatchNumber = generateUniqueBatchNumber();
                    document.getElementById("cropBatchNumber").value = cropBatchNumber;
                    
                    // Show auto-generated batch number
                    document.getElementById("generatedBatch").innerHTML = `
                        <strong>Auto-Generated Batch Number:</strong><br>
                        <span style="font-family: monospace; font-size: 18px; color: #514caf;">${cropBatchNumber}</span>
                    `;
                    document.getElementById("generatedBatch").classList.remove("error");
                    document.getElementById("generatedBatch").classList.add("success");
                    document.getElementById("generatedBatch").style.display = "block";
                    
                    console.log("Auto-generated batch number:", cropBatchNumber);
                } catch (error) {
                    console.error("Error auto-generating batch number:", error);
                    document.getElementById("output").innerText = "Error generating batch number: " + error.message;
                    document.getElementById("output").classList.add("error");
                    return;
                }
            }

            document.getElementById("output").innerText = "Processing... Please wait.";

            try {
                // Convert crop ID to a unique number for smart contract
                const numericId = parseInt(cropId.replace('C', '')); // Convert C001 to 1, C002 to 2, etc.
                
                // Check if batch number already exists (new contract uses batch number as unique key)
                let batchExists = false;
                try {
                    batchExists = await contract.methods.batchExists(cropBatchNumber).call();
                    console.log("Batch exists check result:", batchExists);
                } catch (batchCheckError) {
                    console.error("Error checking batch existence:", batchCheckError);
                    // If batch check fails, we'll proceed with registration and let the contract handle it
                    console.log("Proceeding with registration despite batch check error");
                }
                
                if (batchExists) {
                    document.getElementById("output").innerHTML = `
                        <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #dc3545;">
                            <h4 style="color: #dc3545; margin: 0 0 1rem 0;">❌ Batch Number Already Exists</h4>
                            <p><strong>Batch Number "${cropBatchNumber}" is already registered!</strong></p>
                            <p><strong>💡 Solution:</strong> Please generate a new batch number by clicking "Generate Batch Number" again.</p>
                            <p><strong>Note:</strong> Each batch number must be unique across all crops.</p>
                        </div>
                    `;
                    document.getElementById("output").classList.add("error");
                    return;
                }
                
                // Generate farmer ID
                const farmerId = generateFarmerId(cropManufacturer, userAccount);
                
                // Store comprehensive crop data in localStorage
                const cropData = {
                    cropTypeId: numericId,
                    name: cropName,
                    manufacturer: cropManufacturer,
                    farmerId: farmerId,
                    quantity: parseFloat(cropQuantity),
                    batchNumber: cropBatchNumber,
                    price: parseFloat(cropPrice),
                    owner: userAccount,
                    timestamp: new Date().toISOString(),
                    registrationDate: new Date().toLocaleDateString(),
                    // Additional data for QR code
                    state: document.getElementById("stateSelect").value,
                    districtCode: document.getElementById("districtCode").value,
                    postOfficeNumber: document.getElementById("postOfficeNumber").value
                };
                
                // Store in localStorage with a unique key
                const storageKey = `crop_${cropBatchNumber}_${Date.now()}`;
                localStorage.setItem(storageKey, JSON.stringify(cropData));
                
                // Register crop with new contract (allows multiple registrations of same crop type)
                console.log("Attempting to register crop with parameters:", {
                    cropTypeId: numericId,
                    name: cropName,
                    manufacturer: cropManufacturer,
                    batchNumber: cropBatchNumber,
                    quantity: parseFloat(cropQuantity),
                    price: parseFloat(cropPrice)
                });
                
                const tx = await contract.methods.registerCrop(
                    numericId,           // cropTypeId
                    cropName,            // name
                    cropManufacturer,    // manufacturer
                    cropBatchNumber,     // batchNumber
                    parseFloat(cropQuantity), // quantity
                    parseFloat(cropPrice)     // price
                ).send({ from: userAccount });
                
                console.log("Registration transaction successful:", tx);
                
                document.getElementById("output").innerHTML = `
                    <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="color: #28a745; margin: 0 0 1rem 0;">✅ Crop Registered Successfully!</h4>
                        <p><strong>Crop Type ID:</strong> ${cropId}</p>
                        <p><strong>Crop Name:</strong> ${cropName}</p>
                        <p><strong>Farmer ID:</strong> ${farmerId}</p>
                        <p><strong>Quantity:</strong> ${cropQuantity}kg</p>
                        <p><strong>Price:</strong> ₹${cropPrice}</p>
                        <p><strong>Unique Batch Number:</strong> ${cropBatchNumber}</p>
                        <p><strong>Owner:</strong> ${userAccount}</p>
                        <br>
                        <p><strong>🎉 Great News:</strong> You can now register the same crop type multiple times! Each registration gets a unique batch number automatically.</p>
                        <p><strong>🔄 Next Registration:</strong> Simply register again with the same crop type to get another unique batch number.</p>
                    </div>
                `;
                document.getElementById("output").classList.add("success");
                
                // Show QR code generation buttons
                document.getElementById("generateQRBtn").style.display = "block";
                document.getElementById("testQRBtn").style.display = "block";
                
                showNotification("Crop registered successfully!", "success");
                
            } catch (error) {
                console.error("Registration error:", error);
                let errorMessage = "Error registering crop: ";
                
                if (error.message.includes("Batch number already exists")) {
                    errorMessage = `
                        <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #dc3545;">
                            <h4 style="color: #dc3545; margin: 0 0 1rem 0;">❌ Batch Number Already Exists</h4>
                            <p><strong>This batch number is already registered!</strong></p>
                            <p><strong>💡 Solution:</strong> Generate a new batch number by clicking "Generate Batch Number" again.</p>
                        </div>
                    `;
                } else if (error.message.includes("execution reverted")) {
                    errorMessage += "Transaction failed. Please check your inputs and try again.";
                } else if (error.message.includes("user rejected")) {
                    errorMessage += "Transaction was cancelled by user.";
                } else if (error.message.includes("insufficient funds")) {
                    errorMessage += "Insufficient funds for gas fees.";
                } else {
                    errorMessage += error.message;
                }
                
                document.getElementById("output").innerHTML = errorMessage;
                document.getElementById("output").classList.add("error");
                showNotification("Failed to register crop", "error");
            }
        }

        async function getCropDetailsById() {
            const batchNumber = document.getElementById("cropIdForDetails").value.trim();
            
            // Validate input
            if (!batchNumber) {
                document.getElementById("output").innerText = "Please enter a batch number";
                document.getElementById("output").classList.add("error");
                return;
            }

            // Check if contract is ready
            if (!isContractReady()) {
                const status = getContractStatus();
                document.getElementById("output").innerText = `Contract not ready: ${status}. Please connect your wallet first.`;
                document.getElementById("output").classList.add("error");
                showNotification("Please connect your wallet first", "error");
                return;
            }

            try {
                // Show loading state
                document.getElementById("output").innerText = "Loading crop details...";
                document.getElementById("output").classList.remove("error", "success");
                
                const crop = await contract.methods.getCropByBatch(batchNumber).call();
                
                // Check if crop exists
                if (!crop || crop[3] === "") {
                    document.getElementById("output").innerText = "Crop not found with batch number: " + batchNumber;
                    document.getElementById("output").classList.add("error");
                    return;
                }

                // Convert timestamp to readable date
                const registrationDate = new Date(parseInt(crop[5]) * 1000).toLocaleDateString();

                document.getElementById("output").innerHTML = `
                    <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="color: #28a745; margin: 0 0 1rem 0;">✅ Crop Details Found</h4>
                        <p><strong>Crop Type ID:</strong> C${crop[0].toString().padStart(3, '0')}</p>
                        <p><strong>Name:</strong> ${crop[1] || 'N/A'}</p>
                        <p><strong>Producer:</strong> ${crop[2] || 'N/A'}</p>
                        <p><strong>Batch Number:</strong> ${crop[3] || 'N/A'}</p>
                        <p><strong>Owner:</strong> ${crop[4] || 'N/A'}</p>
                        <p><strong>Registration Date:</strong> ${registrationDate}</p>
                        <p><strong>Quantity:</strong> ${crop[6] || 'N/A'} kg</p>
                        <p><strong>Price:</strong> ₹${crop[7] || 'N/A'}</p>
                    </div>
                `;
                document.getElementById("output").classList.add("success");
                showNotification("Crop details loaded successfully!", "success");
                
            } catch (error) {
                console.error("Error fetching crop details:", error);
                let errorMessage = "Error fetching crop details: ";
                
                if (error.message.includes("execution reverted")) {
                    errorMessage += "Crop not found or contract error";
                } else if (error.message.includes("network")) {
                    errorMessage += "Network connection error. Please check your internet connection.";
                } else {
                    errorMessage += error.message;
                }
                
                document.getElementById("output").innerText = errorMessage;
                document.getElementById("output").classList.add("error");
                showNotification("Failed to fetch crop details", "error");
            }
        }

        async function transferOwnership() {
            const batchNumber = document.getElementById("transferId").value.trim();
            const newOwner = document.getElementById("newOwner").value;
            const newOwnerName = document.getElementById("newOwnerName").value;
            
            // Validate inputs
            if (!batchNumber) {
                document.getElementById("output").innerText = "Please enter a valid batch number";
                document.getElementById("output").classList.add("error");
                return;
            }
            
            if (!newOwner || !newOwner.startsWith('0x') || newOwner.length !== 42) {
                document.getElementById("output").innerText = "Please enter a valid Ethereum address (0x...)";
                document.getElementById("output").classList.add("error");
                return;
            }

            // Check if contract is ready
            if (!isContractReady()) {
                const status = getContractStatus();
                document.getElementById("output").innerText = `Contract not ready: ${status}. Please connect your wallet first.`;
                document.getElementById("output").classList.add("error");
                showNotification("Please connect your wallet first", "error");
                return;
            }

            try {
                // Show loading state
                document.getElementById("output").innerText = "Transferring ownership...";
                document.getElementById("output").classList.remove("error", "success");
                
                let transaction;
                
                // Use different contract methods based on whether new owner name is provided
                if (newOwnerName && newOwnerName.trim() !== "") {
                    // Transfer ownership and update manufacturer name
                    transaction = await contract.methods.transferOwnershipWithName(batchNumber, newOwner, newOwnerName.trim()).send({ from: userAccount });
                } else {
                    // Just transfer ownership without changing manufacturer name
                    transaction = await contract.methods.transferOwnership(batchNumber, newOwner).send({ from: userAccount });
                }
                
                // Create success message based on what was updated
                let successMessage = `
                    <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="color: #28a745; margin: 0 0 1rem 0;">✅ Ownership Transferred Successfully</h4>
                        <p><strong>Batch Number:</strong> ${batchNumber}</p>
                        <p><strong>New Owner Address:</strong> ${newOwner}</p>
                        <p><strong>Previous Owner:</strong> ${userAccount}</p>
                `;
                
                if (newOwnerName && newOwnerName.trim() !== "") {
                    successMessage += `<p><strong>New Owner Name:</strong> ${newOwnerName.trim()}</p>`;
                    successMessage += `<p><em style="color: #28a745;">✅ Manufacturer/Producer name has been updated</em></p>`;
                } else {
                    successMessage += `<p><em>Manufacturer/Producer name remains unchanged</em></p>`;
                }
                
                successMessage += `</div>`;
                
                document.getElementById("output").innerHTML = successMessage;
                document.getElementById("output").classList.add("success");
                showNotification("Ownership transferred successfully!", "success");
                
                // Clear the form
                document.getElementById("transferId").value = "";
                document.getElementById("newOwner").value = "";
                document.getElementById("newOwnerName").value = "";
                
            } catch (error) {
                console.error("Error transferring ownership:", error);
                let errorMessage = "Error transferring ownership: ";
                
                if (error.message.includes("execution reverted")) {
                    errorMessage += "Transaction failed. You may not be the owner of this crop.";
                } else if (error.message.includes("user rejected")) {
                    errorMessage += "Transaction was cancelled by user.";
                } else if (error.message.includes("insufficient funds")) {
                    errorMessage += "Insufficient funds for gas fees.";
                } else {
                    errorMessage += error.message;
                }
                
                document.getElementById("output").innerText = errorMessage;
                document.getElementById("output").classList.add("error");
                showNotification("Failed to transfer ownership", "error");
            }
        }

        // Function to update manufacturer name only
        async function updateManufacturerName() {
            const batchNumber = document.getElementById("updateNameCropId").value.trim();
            const newManufacturerName = document.getElementById("newManufacturerName").value;
            
            // Validate inputs
            if (!batchNumber) {
                document.getElementById("output").innerText = "Please enter a valid batch number";
                document.getElementById("output").classList.add("error");
                return;
            }
            
            if (!newManufacturerName || newManufacturerName.trim() === "") {
                document.getElementById("output").innerText = "Please enter a new manufacturer name";
                document.getElementById("output").classList.add("error");
                return;
            }

            // Check if contract is ready
            if (!isContractReady()) {
                const status = getContractStatus();
                document.getElementById("output").innerText = `Contract not ready: ${status}. Please connect your wallet first.`;
                document.getElementById("output").classList.add("error");
                showNotification("Please connect your wallet first", "error");
                return;
            }

            try {
                // Show loading state
                document.getElementById("output").innerText = "Updating manufacturer name...";
                document.getElementById("output").classList.remove("error", "success");
                
                await contract.methods.updateManufacturer(batchNumber, newManufacturerName.trim()).send({ from: userAccount });
                
                document.getElementById("output").innerHTML = `
                    <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="color: #28a745; margin: 0 0 1rem 0;">✅ Manufacturer Name Updated Successfully</h4>
                        <p><strong>Batch Number:</strong> ${batchNumber}</p>
                        <p><strong>New Manufacturer Name:</strong> ${newManufacturerName.trim()}</p>
                        <p><strong>Owner:</strong> ${userAccount}</p>
                        <p><em>Manufacturer/Producer name has been updated on the blockchain</em></p>
                    </div>
                `;
                document.getElementById("output").classList.add("success");
                showNotification("Manufacturer name updated successfully!", "success");
                
                // Clear the form
                document.getElementById("updateNameCropId").value = "";
                document.getElementById("newManufacturerName").value = "";
                
            } catch (error) {
                console.error("Error updating manufacturer name:", error);
                let errorMessage = "Error updating manufacturer name: ";
                
                if (error.message.includes("execution reverted")) {
                    errorMessage += "Transaction failed. You may not be the owner of this crop.";
                } else if (error.message.includes("user rejected")) {
                    errorMessage += "Transaction was cancelled by user.";
                } else if (error.message.includes("insufficient funds")) {
                    errorMessage += "Insufficient funds for gas fees.";
                } else {
                    errorMessage += error.message;
                }
                
                document.getElementById("output").innerText = errorMessage;
                document.getElementById("output").classList.add("error");
                showNotification("Failed to update manufacturer name", "error");
            }
        }

        // Function to check if QR code library is loaded
        function checkQRLibrary() {
            if (typeof QRCode === 'undefined') {
                console.error("QRCode library not loaded");
                return false;
            }
            return true;
        }

        // Function to generate QR code with crop data
        async function generateQRCode() {
            try {
                // Get the latest registered crop data
                const cropData = getLatestCropData();
                if (!cropData) {
                    alert("No crop data found. Please register a crop first.");
                    return;
                }

                // Create QR code data structure
                const qrData = {
                    type: "Croponchain",
                    version: "2.0",
                    cropTypeId: `C${cropData.cropTypeId.toString().padStart(3, '0')}`,
                    cropName: cropData.name,
                    farmerName: cropData.manufacturer,
                    farmerId: cropData.farmerId,
                    quantity: cropData.quantity,
                    unit: "kg",
                    batchNumber: cropData.batchNumber,
                    price: cropData.price,
                    currency: "INR",
                    registrationDate: cropData.registrationDate,
                    origin: {
                        state: cropData.state,
                        districtCode: cropData.districtCode,
                        postOfficeNumber: cropData.postOfficeNumber
                    },
                    blockchain: {
                        contractAddress: contractAddress,
                        owner: cropData.owner,
                        timestamp: cropData.timestamp
                    },
                    verification: {
                        url: window.location.origin + "/verify.html",
                        batchId: cropData.batchNumber
                    }
                };

                // Convert to JSON string
                const qrString = JSON.stringify(qrData, null, 2);
                
                // Generate QR code
                const qrContainer = document.getElementById("qrCodeContainer");
                qrContainer.innerHTML = ""; // Clear previous QR code
                
                // Check if QRCode library is loaded
                if (!checkQRLibrary()) {
                    // Fallback: Use QR code web service
                    console.log("Using QR code web service fallback");
                    const encodedData = encodeURIComponent(qrString);
                    const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodedData}`;
                    
                    qrContainer.innerHTML = `
                        <img src="${qrImageUrl}" alt="QR Code" style="max-width: 300px; height: auto;" />
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">QR Code generated via web service</p>
                    `;
                } else {
                    // Generate QR code using QRCode.js
                    await QRCode.toCanvas(qrContainer, qrString, {
                        width: 300,
                        height: 300,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    });
                }

                // Show QR code display
                document.getElementById("qrCodeDisplay").style.display = "block";
                
                // Store QR data for download
                window.currentQRData = qrString;
                
                console.log("QR Code generated successfully");
                console.log("QR Data:", qrData);

            } catch (error) {
                console.error("Error generating QR code:", error);
                
                // Fallback: Show data in text format
                const qrContainer = document.getElementById("qrCodeContainer");
                const cropData = getLatestCropData();
                if (cropData) {
                    const qrString = JSON.stringify({
                        type: "Croponchain",
                        version: "2.0",
                        cropTypeId: `C${cropData.cropTypeId.toString().padStart(3, '0')}`,
                        cropName: cropData.name,
                        farmerName: cropData.manufacturer,
                        farmerId: cropData.farmerId,
                        quantity: cropData.quantity,
                        batchNumber: cropData.batchNumber,
                        price: cropData.price,
                        registrationDate: cropData.registrationDate
                    }, null, 2);
                    
                    qrContainer.innerHTML = `
                        <div style="border: 2px solid #514caf; padding: 20px; background: white; max-width: 300px; word-break: break-all;">
                            <h4 style="color: #514caf; margin: 0 0 10px 0;">QR Code Data</h4>
                            <p style="font-size: 12px; margin: 0;">Copy this data to generate QR code:</p>
                            <textarea readonly style="width: 100%; height: 200px; margin: 10px 0; font-size: 10px; border: 1px solid #ccc;">${qrString}</textarea>
                            <button onclick="copyQRData()" class="btn btn-primary" style="font-size: 12px; padding: 5px 10px;">Copy Data</button>
                        </div>
                    `;
                    document.getElementById("qrCodeDisplay").style.display = "block";
                } else {
                    alert("Error generating QR code: " + error.message);
                }
            }
        }

        // Function to copy QR data to clipboard
        function copyQRData() {
            if (window.currentQRData) {
                navigator.clipboard.writeText(window.currentQRData).then(() => {
                    alert("QR data copied to clipboard!");
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement("textarea");
                    textArea.value = window.currentQRData;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textArea);
                    alert("QR data copied to clipboard!");
                });
            }
        }

        // Function to test QR library
        function testQRLibrary() {
            console.log("Testing QR library...");
            console.log("QRCode available:", typeof QRCode !== 'undefined');
            
            if (typeof QRCode !== 'undefined') {
                alert("✅ QRCode library is loaded and ready!");
                console.log("QRCode library is available");
            } else {
                alert("❌ QRCode library is not loaded. Please refresh the page.");
                console.error("QRCode library not available");
            }
        }

        // Function to get the latest crop data from localStorage
        function getLatestCropData() {
            let latestData = null;
            let latestTimestamp = 0;
            
            for (let key in localStorage) {
                if (key.startsWith('crop_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data.timestamp && new Date(data.timestamp).getTime() > latestTimestamp) {
                            latestTimestamp = new Date(data.timestamp).getTime();
                            latestData = data;
                        }
                    } catch (e) {
                        // Skip invalid data
                    }
                }
            }
            
            return latestData;
        }

        // Function to download QR code
        function downloadQRCode() {
            const canvas = document.querySelector('#qrCodeContainer canvas');
            const img = document.querySelector('#qrCodeContainer img');
            
            if (canvas) {
                // Download canvas QR code
                const link = document.createElement('a');
                link.download = `crop-qr-${getLatestCropData()?.batchNumber || 'code'}.png`;
                link.href = canvas.toDataURL();
                link.click();
            } else if (img) {
                // Download image QR code
                const link = document.createElement('a');
                link.download = `crop-qr-${getLatestCropData()?.batchNumber || 'code'}.png`;
                link.href = img.src;
                link.click();
            } else {
                alert("No QR code to download. Please generate a QR code first.");
            }
        }

        // Function to browse marketplace for a specific crop
        function browseMarketplace() {
            const selectedCrop = document.getElementById("marketplaceCropSelect").value;

            if (!selectedCrop) {
                alert("Please select a crop to browse the marketplace.");
                return;
            }

            const selectedOption = document.getElementById("marketplaceCropSelect").options[document.getElementById("marketplaceCropSelect").selectedIndex];
            const cropId = selectedOption.dataset.cropId;

            // Debug: Log the values being passed
            console.log("Selected crop:", selectedCrop);
            console.log("Crop ID:", cropId);
            console.log("Selected option:", selectedOption);

            // Store crop data in localStorage as backup
            localStorage.setItem('selectedCropData', JSON.stringify({
                cropId: cropId,
                cropName: selectedCrop,
                timestamp: Date.now()
            }));

            // Redirect to marketplace page with crop parameters
            const marketplaceUrl = `marketplace.html?cropId=${encodeURIComponent(cropId)}&cropName=${encodeURIComponent(selectedCrop)}`;
            console.log("Marketplace URL:", marketplaceUrl);
            window.open(marketplaceUrl, '_blank');
        }

        // Attach events after DOM is ready
        window.addEventListener("DOMContentLoaded", () => {
            // Initialize crop dropdown
            populateCropDropdown();
            
            // Attach event listeners
            document.getElementById("connectBtn").addEventListener("click", initWeb3);
            document.getElementById("cropName").addEventListener("change", handleCropSelection);
            document.getElementById("generateBatchBtn").addEventListener("click", generateBatchNumber);
            
            // Add event listeners for automatic batch number generation
            document.getElementById("stateSelect").addEventListener("change", autoGenerateBatchNumber);
            document.getElementById("districtCode").addEventListener("input", autoGenerateBatchNumber);
            document.getElementById("postOfficeNumber").addEventListener("input", autoGenerateBatchNumber);
            document.getElementById("registerCropBtn").addEventListener("click", registerCrop);
            document.getElementById("generateQRBtn").addEventListener("click", generateQRCode);
            document.getElementById("testQRBtn").addEventListener("click", testQRLibrary);
            document.getElementById("downloadQRBtn").addEventListener("click", downloadQRCode);
            document.getElementById("browseMarketplaceBtn").addEventListener("click", browseMarketplace);
            document.getElementById("getCropDetailsBtn").addEventListener("click", getCropDetailsById);
            document.getElementById("transferOwnershipBtn").addEventListener("click", transferOwnership);
            document.getElementById("updateManufacturerBtn").addEventListener("click", updateManufacturerName);
        });
    </script>

</body>
</html>
